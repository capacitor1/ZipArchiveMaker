# ZipArchiveMaker

多功能Zip打包器：资源分享者必备，更好地分卷、打包，防止网盘审查文件。

<img width="499" height="291" alt="{C8622AB7-C3C4-4879-8F6D-3336A42C3AFB}" src="https://github.com/user-attachments/assets/f7f148f6-12f1-46b4-94ae-b437dae379dc" />

版本更新记录日志参见[此处](ChangeLog.md)

## 功能总览&适用场景

- 提供多数比较特殊或不太常见的打包方法。（*如仅需正常打包操作，请使用[7-zip](https://www.7-zip.org/)等知名的专业软件。*）

- 适用于某些特殊情况下的文件打包、分卷。降低对用户的磁盘要求、提高文件容错性：如 *伪分卷* 等。

- 适用于在各大网盘分享资源时，绕过文件审查；或上传自己隐私文件时，避免加密压缩包导致密码遗忘但又要防止网盘审查。

- 适用于在分享资源、分发Galgame时个性化压缩包体：*图片+压缩包*等功能可以做到这一点（自制一张Logo图片或者宣传图并选择为压缩包图片）。
  
## 各项功能用法说明

### 0 全局说明

- UI左侧的列表：
    - 可以点击列表上方的按钮来添加多项文件。
 
    - 可以拖动文件/文件夹到列表。
 
    - 可以Ctrl+V粘贴文件/文件夹/**数据**[^1]
 
    - 按Delete键移除选中的项目；双击项目使用系统默认方式打开文件；按Ctrl+C复制选中项目的路径（多个路径将使用回车分割）。
 
- 在上方选项中选择需要的模式并填入相关参数，然后点击“执行”会开始处理压缩包。**如果输入不符合规范也能开始执行，但这将不会有正确的结果输出！**

- “最小大小”“最大大小”等大小输入框说明：

    - 允许直接输入数值以定义大小。当输入long的最大值时，视为无穷大处理。
 
    - 允许输入带有单位的大小（不允许空格）。如`1G` 或 `1GB`。[^2]
 
- 数值输入框说明：

    - 不会检查输入值是否符合范围。只有滚动鼠标滚轮或点击上下按钮时才有范围限制。故不要“测试”一些奇奇怪怪东西，一定会报错。
 
- 输出Zip文件全量启用Zip64模式，老旧解压软件或部分自动程序可能不支持。

### 1 普通打包

- 制作正常的压缩包。
  
### 2 每个文件单独打包Zip

- 字面意思。此方法会逐一压缩并创建对应的压缩包，创建的文件夹以执行时间命名。

- 如果取消“保留原文件后缀”选项，有可能会因为原始路径中包含同名不同后缀的文件而导致输出缺少相关文件（不会将这些文件压缩至同一个压缩包）。

### 3 每个文件单独打包Zstd

- 功能特性同 `2 每个文件单独打包Zip`。但是采用Zstd格式压缩。

### 4 伪分卷

- 预期功能和正常的分卷一致，但此方法分卷会得到一些大小不一定相等（取决于文件的具体大小，如果设置最小大小为1G但输入的文件有10G，那么那一个分卷也会有10G大。）的分卷文件，以`.part{N}.zip`为结尾（N为卷序号，此序号也会写入zip注释）。

- 此方法可用于对体积过大的文件进行打包，用户在解压时无需预留出2倍空间来解压分卷；空间不足者可少量多次分批解压此类分卷（甚至对于不依赖文件内容完整性的情况，无需下载所有的分卷即可开始解压）。

### 5 不定大小分卷

> 此方法本身是为切分已经准备好的大文件而准备，故如果不选择“将项目当作完整包”，则会二次处理输出的Zip文件。

- 此方法与常规分卷无区别，切分出后缀为`.{N}`的常规分卷。但是，每个分卷大小会在最小值和最大值之间随机，而不是前 N - 1 个分卷为固定值；第 N 个卷为剩余的部分。这可以防止某些软件针对文件大小检查是否为分卷。

### 6 带密码保护打包

- 此法与常规Zip加密打包无区别，但此法只能使用`ZipCrypto`模式（本身此法就会在文件中写入密码，故加密方法安全性可以忽略）。

- UI界面提供一个简单的仅ASCII字符的随机字符生成器。即使不需要加密任何压缩包，也可使用这个生成器产生一些有趣的东西。

- **警告：会将密码写入zip包体！不具有安全性！仅用于防止自动程序解密其内容或包体被网盘检查！**

### 7 图片+压缩包

- 在压缩包前插入一张图片（或其他内容），达到所谓“图种”的效果；也可避免自动程序检查文件（这只是一张图片，不是好康的！）

- 另外，还额外提供在图片和压缩包之间插入自定义长度数据的功能。这可以方便后续人为在这之间继续加入菜单数据或另一个小的zip压缩包来欺骗自动程序[^3]。

- 此法会将关于图片、Offset数据的基本信息以纯文本写入Zip注释，以避免有时候因为插入的数据问题导致的无法解压。

### 8 打乱文件名+额外索引

- 将正常压缩包存储的文件名随机化。

- 支持的随机模式与索引写入模式如下：

<img width="265" height="218" alt="{6B7DCF86-A0C5-4DFC-B752-B5C086E5F60E}" src="https://github.com/user-attachments/assets/782df717-3674-4a09-b00b-13a3a088527a" />

<img width="278" height="143" alt="{62B585A9-22DA-47A2-8CE8-C76820AFCB9B}" src="https://github.com/user-attachments/assets/0e26aa8d-1224-4c6d-9749-72d592b18029" />

- 使用这些模式的组合可以做到使压缩包内的文件名无法被猜测出含义。但用户需要自行根据索引文件的内容恢复压缩包内容的文件名。

### 9 双层压缩Zstd+Zip

- 先将文件压缩在Zstd文件内，再写入Zip中。

> 注意：此法会两次读写硬盘文件，中间的缓存文件与本软件在同一个目录下。

> 注意：Zip层的压缩模式被强制锁定在0（仅存储）。

### 10 图片+伪分卷

- 合并了 `7 图片+压缩包` `4 伪分卷`两个功能，此时每个分卷包体都带有同一张图片和相同的插入数据。

### 11 Xor加密+Zip打包

- 将输出的Zip包体使用预设的Key进行Xor运算。这将改变整个压缩包的数据内容，使其无法被打开。

- 用户需根据这个Key，对整个文件进行解密，然后才能打开压缩包。

### 12 伪文件头+多Zip拼接

**这是一个高级模式[^4]。**

- 伪文件头将会在文件开头额外添加0x504B0304（Zip文件头标识），并在接下来的4字节内写入子Zip的总数量，其后再根据设置项写入插入的数据。然后紧跟各个子Zip，每个Zip之间不再插入数据。文件的结尾处则会写入一个long[]数组，写入每个子Zip的Offset。数组长度等于子Zip的总数量，数值均为小端序。

- 需要用户自行编写脚本或代码进行解压缩。

### 13 自定义替换Zip文件头

**这是一个高级模式。**

- 仅修改Zip的文件头（0x504B0304）部分，不影响其余数据。

- 注意：此修改会将修改处的Offset单独列出表格（单独的.lst文件，整个文件为一个long[]数组，每个long代表被修改的部分的Offset），而不是将修改存储在文件内。数组数值为小端序。7-zip等常规软件均不支持读取自定义文件头的Zip，故需要自行考虑如何打开此种文件。

- *此替换仅会替换每个ZipEntry数据开头的那个文件头。对于Zip末尾的文件结尾“文件头”和附加数据块不做修改。*

- 需要用户自行编写脚本或代码进行解压缩。

## 外部依赖库和支持

- Zip压缩核心部分使用 [SharpZipLib](https://github.com/icsharpcode/SharpZipLib)

- Zstd压缩核心使用 [SharpZstd](https://github.com/TechPizzaDev/SharpZstd) ([Nuget](https://www.nuget.org/packages/SharpZstd))

- XoredStream方法使用[GARbro/ArcFormats/CommonStreams.cs](https://github.com/morkt/GARbro/blob/master/ArcFormats/CommonStreams.cs)

***

[^1]:如果剪贴板中有图像、文本数据，会自动粘贴到缓存路径并作为待压缩的一项。这将把数据压缩在压缩包的根目录，以粘贴时间为后缀。

[^2]:对于`1GBBB`这种东西也能正常处理，但`1GGBB`不行。

[^3]:7-zip等常规软件可以识别这种Offset不等于0的压缩包文件。故可能*某些平台*也可能检查到。

[^4]:软件内对高级模式会显示`（高级）`。这些模式会从字节底层修改Zip文件，或新增自定义的二进制数据结构。普通用户不建议使用，也不建议对普通用户推荐或发布这种模式处理的压缩包。
